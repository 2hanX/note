### 免杀相关定义

#### 特征码

- 特征码主要用来判断某段数据属于哪个计算机字段
- 病毒特征码主要由反病毒公司制作，一般都是被反病毒软件公司确定为只有该病毒才可能会有的一串二进制字符串，而这字符串通常是文件里对应程式码或汇编指令的地址
- 杀毒软件会将这一串二进制字符串用某种方法与目标文件或处理程序作对比，从而判定该文件或进程是否感染病毒

#### Ring0

- 计算机中有一个用于控制CPU完成各项功能的命令系统，叫做“指令系统”
- 指令系统将指令分为==特权指令==与==普通指令==。对于一些危险的指令（即绝大部分特权指令），只允许操作系统及其相关模块使用，而普通的应用程序只能使用那些不会造成灾难的指令（即普通指令）
- Intel的CPU将特权级别分为4层，它们分别是**Ring0**，**Ring1**，**Ring2**与**Ring3**。Ring0为底层，也就是所谓的“内核层”，也是操作系统的底层；Ring3为最高层，也就是用户层

### 免杀分类

#### 分类1

- 无源码免杀（二进制免杀），只能通过通过修改asm代码（字节框架代码）／二进制数据（二进制class文件）／其他数据来完成免杀
- 有源码免杀，可以通过修改源代码来完成免杀，也可以结合二进制免杀的技术

#### 分类2

- 静态文件免杀，被杀毒软件病毒库/云查杀了，也就是文件特征码在病毒库了。免杀方式可能是上面的两种方式
- 动态行为免杀，运行中执行的某些行为被杀毒软件拦截报读。行为免杀如果没有源码就不是很好搞了

#### 分类3

- 文件免杀，基于文件的免杀基本上就是破坏原有程序的特征。无论是修改特征码还是加上一段花指令还是加壳，目的就是为了打乱或加密可执行文件内部的数据。
- 内存免杀，数据进入CPU之前会在内存中处理成可以直接被CPU执行的形式。通过选择扫描内存的形式去查杀木马。将要被执行的程序肯定比未执行程序的威胁更大。再厉害的木马只要能保证它不被执行，它在用户的计算机中最多也就是算是一个垃圾文件，就不会对用户及网络构成任何威胁。
- 行为免杀，从最早的“文件防火墙”发展到后来的“主动防御”，再到现在的部分“云查杀”，其实都应用了行为查杀技术。常见行为添加服务、创建驱动、释放资源、添加注册表、增加自启动、创建互斥体、遍历全硬盘的文件、远程线程注入、HOOK

### 如何免杀

#### 修改特征码

1. 定位特征码 [^1]
2. 修改特征码 [^2]
   - 修改特征码的十六进制 [^3]
   - 大小写 [^4]
   - 替换法 [^5]
   - 顺序调换法 [^6]
   - JMP法 [^7]
   - 移位法 [^8]

#### 修改花指令 [^9]

- 常用汇编指令

  | 指令          | 含义           |
  | ------------- | -------------- |
  | `cmp a,b`     | 比较大小       |
  | `mov a,b`     | 传送值         |
  | `nop`         | 什么都不做     |
  | `call`        | 调用子程序     |
  | `pop`         | 出栈           |
  | `push`        | 入栈           |
  | `add`         | 加法           |
  | `adc`         | 带进位加法     |
  | `inc`         | 加1            |
  | `sub`         | 减法           |
  | `sbb`         | 带借位减法     |
  | `dec`         | 减1            |
  | `and`         | 与运算         |
  | `or`          | 或运算         |
  | `xor`         | 异或运算       |
  | `not`         | 取反           |
  | `test`        | 测试           |
  | `je`或`jz`    | 若相等则跳     |
  | `jne`或` jnz` | 若不相等则跳   |
  | `jmp`         | 无条件跳转     |
  | `jb`          | 若小于则跳     |
  | `ja`          | 若大于则跳     |
  | `jg`          | 若大于则跳     |
  | `jge`         | 若大于等于则跳 |
  | `jl`          | 若小于则跳     |
  | `jle`         | 若小于等于则跳 |

  

#### 加壳

- 压缩壳
  - 压缩壳的主要目的是压缩应用程序的体积，例如UPX可以将一般的应用程序压缩到原体积的30%左右
  - 压缩壳并不会对被加壳程序本身做任何修改，而是直至将其换成一种更加节省空间的存储方式
  - 经过压缩壳处理过的程序在真正被CPU执行前是会自动解压缩（解密）的
- 加密壳
  - 加密壳的主要目的是保护原程序不被破解，一般情况下，加密壳会对源程序进行一定的修改，例如代码乱序、代码混淆等
  - 经过加密壳处理的程序即便是提交给CPU去执行，源程序的代码也还是发生了改变
- 代码乱序
  - 将本来线性执行的代码分成若干份后颠倒存储位置，再通过跳转指令将其按照正确的顺序连接起来
  - 代码乱序对于CPU来说其执行的程序逻辑没变，只是多了几条跳转指令，但是这段代码在硬盘上或内存中的组织排列方式却发生了很大的变化
- 代码混淆
  - 本质就是一条指令扩展为若干条指令，例如原本是一个计算`1+1`的代码，但是混淆后就变成了`1+10-9+0-0+1-1`
- 虚拟机保护壳
  - 关键技术在于实现一个软件版本的CPU，被加密的可执行代码不再遵循 Intel 制定的 OPCode 标准，而是执行由虚拟机作者本身制定的非公开的、动态的CPU指令编码解码标准，我们通常称之为TextCode



[原文](https://www.freebuf.com/column/204005.html)

---

[^1]: 常用定位木马病毒特征码的工具有四款：**CCL**、**MultiCCL**、**MYCCL**、**VirTest**
[^2]: 常用的修改工具有：**OD**、**C32ASM**、**UE**、**010Editor**、**winhex**
[^3]: 把特征码所对应的十六进制改成**数字+1**或者**减1**
[^4]: 特征码所对应的内容是字符串时进行大小写字符互换
[^5]: 特征码所对应的**汇编指令**替换成相同或相似的，例如：`jnz`换成`JMP`
[^6]: 特征码对应的指令顺序互换
[^7]: 把特征码移到零区域，然后一个`JMP`又跳回来执行
[^8]: 把定位到函数的特征码复制，然后`NOP`找到 0 区域写入刚`NOP`代码，然后`JMP`回到原来`NOP`的下面一个地址，然后`lordpe`修改相应函数的地址
[^9]: 花指令是由设计者特别构思，希望反汇编的时候出错，让破解者无法清楚正确地反汇编程序的内容，迷失方向